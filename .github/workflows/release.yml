name: Main

on: push

jobs:
  build:
    runs-on: ubuntu-latest
    steps:
      - name: Checkout
        uses: actions/checkout@v3
      - name: Install nix
        uses: cachix/install-nix-action@v20
        with:
          nix_path: nixpkgs=https://github.com/nixos/nixpkgs/archive/release-22.11.tar.gz
          extra_nix_config: |
            trusted-public-keys = cache.nixos.org-1:6NCHdD59X431o0gWypbMrAURkbJ16ZPMQFGspcDShjY= hydra.iohk.io:f/Ea+s+dFdN+3Y/G+FDgSq+a5NEWhJGzdjvKNGv0/EQ= "loony-tools:pr9m4BkM/5/eSTZlkQyRt57Jz7OMBxNSUiMC4FkcNfk="
            substituters = https://cache.nixos.org/ https://cache.iog.io/ https://cache.zw3rk.com/
      - name: Build
        uses: workflow/nix-shell-action@v3.2.1
        with:
          packages: stdenv, curl, jq, diffutils
        script:
      - name: Build
        run: |
          mkdir __pkgs
          pushd __pkgs
            echo ${{ github.sha }} > COMMIT_SHA
            for sys in msys2 darwin debian; do
              for lib in libsodium libsodium-vrf libsecp256k1 libblst; do
                cp -f $(nix build .#dist.$sys.$lib --no-link --print-out-paths -L)/*.{zstd,pkg,deb} .
              done
            done
          popd
      - name: Release
        uses: softprops/action-gh-release@v1
        if: startsWith(github.ref, 'refs/tags/')
        with:
          files: __pkgs/*
